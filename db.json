const fs = require('fs');
const path = require('path');

const dbPath = path.join(__dirname, '..', 'subscriptions.json');

const init = () => {
    if (!fs.existsSync(dbPath)) {
        const initialStructure = {
            settings: {
                welcomeMessage: "ðŸ‘‹ *Bem-vindo(a)!*\n\nAqui comeÃ§a sua experiÃªncia premium! ðŸ”¥\n\nEscolha o plano ideal e aproveite agora mesmo o acesso completo a tudo que preparamos pra vocÃª.\n\nPagou? Acesso liberado na hora! ðŸ’¥",

                welcomeMedia: {
                    isActive: false,
                    fileId: null,
                    type: null,
                    audio: {
                        isActive: false,
                        fileId: null
                    }
                },
                supportLink: "https://t.me/SEU_USUARIO_DE_SUPORTE",
                previewsChannel: {
                    link: "https://t.me/seu_canal_de_previas",
                    buttonText: "ðŸ‘€ Espiar PrÃ©vias Exclusivas",
                    isActive: false
                },
                payment: {
                    mercadoPago: {
                        accessToken: null,
                        isActive: false 
                    },
                    pushinpay: {
                        apiToken: null,
                        isActive: false
                    },
                    triboPay: {
                        apiToken: null,
                        isActive: false
                    },
                    pepper: {
                        accessToken: null,
                        isActive: false
                    }
                },
                plans: {
                    weekly: { name: "Semanal", price: 7.99, days: 7, isActive: true, offer_hash: null, product_hash: null, pepper_offer_hash: null, pepper_product_hash: null },
                    biweekly: { name: "Quinzenal", price: 14.99, days: 15, isActive: true, offer_hash: null, product_hash: null, pepper_offer_hash: null, pepper_product_hash: null },
                    monthly: { name: "Mensal", price: 24.99, days: 30, isActive: true, offer_hash: null, product_hash: null, pepper_offer_hash: null, pepper_product_hash: null },
                    annual: { name: "Anual", price: 249.99, days: 365, isActive: false, offer_hash: null, product_hash: null, pepper_offer_hash: null, pepper_product_hash: null },
                    lifetime: { name: "VitalÃ­cio", price: 499.99, days: 9999, isActive: false, offer_hash: null, product_hash: null, pepper_offer_hash: null, pepper_product_hash: null }
                }
            },
            activeSubscriptions: [],
            allUsers: [],
            pendingPayments: {}
        };
        writeDbFile(initialStructure);
        console.log('Arquivo subscriptions.json nÃ£o encontrado. Um novo foi criado com a estrutura inicial.');
    }
};

const readDbFile = () => JSON.parse(fs.readFileSync(dbPath, 'utf8'));
const writeDbFile = (data) => fs.writeFileSync(dbPath, JSON.stringify(data, null, 2), 'utf8');

module.exports = {
    init,

    getAllUsers: () => readDbFile().allUsers || [],
    addUser: (userId) => {
        const db = readDbFile();
        if (!db.allUsers) db.allUsers = [];
        if (!db.allUsers.includes(userId)) {
            db.allUsers.push(userId);
            writeDbFile(db);
        }
    },

    getPendingPayments: () => readDbFile().pendingPayments || {},
    addPendingPayment: (paymentId, data) => {
        const db = readDbFile();
        if (!db.pendingPayments) db.pendingPayments = {};
        db.pendingPayments[paymentId] = data;
        writeDbFile(db);
    },
    getPendingPayment: (paymentId) => (readDbFile().pendingPayments || {})[paymentId],
    removePendingPayment: (paymentId) => {
        const db = readDbFile();
        if (db.pendingPayments && db.pendingPayments[paymentId]) {
            delete db.pendingPayments[paymentId];
            writeDbFile(db);
        }
    },

    getSubscriptions: () => readDbFile().activeSubscriptions || [],
    addSubscription: (subscription) => {
        const db = readDbFile();
        if (!db.activeSubscriptions) db.activeSubscriptions = [];
        db.activeSubscriptions = db.activeSubscriptions.filter(s => s.userId !== subscription.userId);
        db.activeSubscriptions.push(subscription);
        writeDbFile(db);
    },
    updateAllSubscriptions: (allSubscriptions) => {
        const db = readDbFile();
        db.activeSubscriptions = allSubscriptions;
        writeDbFile(db);
    },
    getUserActiveSubscription: (userId) => {
        const now = new Date();
        const subscriptions = readDbFile().activeSubscriptions || [];
        return subscriptions.find(sub => sub.userId === userId && new Date(sub.expiryDate) > now);
    },
    
    getSettings: () => readDbFile().settings,
    updateSettings: (newSettings) => {
        const db = readDbFile();
        db.settings = newSettings;
        writeDbFile(db);
    },
};